<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BizFitã‚¯ãƒ©ãƒ– | 8LABO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <style>
        :root { --8labo-orange: #F39800; }
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f8fafc; }
        .bg-8labo { background-color: var(--8labo-orange); }
        .text-8labo { color: var(--8labo-orange); }
        .page { display: none; }
        .page.active { display: block; }
        
        /* ğŸ”¥ ãƒœã‚¿ãƒ³å‹•ä½œå¾©æ—§ã®ãŸã‚ã®é‡è¦è¨­å®š */
        .btn-safe-click {
            position: relative !important;
            z-index: 99999 !important;
            pointer-events: auto !important;
        }
        .event-card { pointer-events: none; }
        .event-card > * { pointer-events: auto; }

        .progress-ring { transform: rotate(-90deg); }
        .progress-ring circle { fill: transparent; stroke-width: 12; transition: stroke-dasharray 0.8s ease; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100000; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
    </style>
</head>
<body>
    <header class="bg-white border-b sticky top-0 z-[50000] p-4">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="goHome()">
                <div class="w-8 h-8 bg-8labo rounded-lg flex items-center justify-center text-white font-bold">8</div>
                <h1 class="font-bold text-xl">BizFit<span class="text-8labo">ã‚¯ãƒ©ãƒ–</span></h1>
            </div>
            <div id="header-nav"></div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto p-4">
        <section id="page-guest-top" class="page space-y-8">
            <div class="text-center py-12 space-y-4">
                <h2 class="text-4xl font-black">é‹å‹•ã‚’ç¿’æ…£ã«ã€<br><span class="text-8labo">åœ°åŸŸã‚’ç¬‘é¡”ã«ã€‚</span></h2>
                <button onclick="navigateTo('login')" class="bg-8labo text-white px-8 py-3 rounded-xl font-bold">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </div>
            <div id="guest-event-grid" class="grid md:grid-cols-2 gap-6"></div>
        </section>

        <section id="page-login" class="page max-w-md mx-auto py-12">
            <div class="bg-white p-8 rounded-3xl shadow-xl">
                <h2 class="text-2xl font-bold mb-6 text-center">ãƒ­ã‚°ã‚¤ãƒ³</h2>
                <form onsubmit="event.preventDefault(); handleLoginSubmit();" class="space-y-4">
                    <input type="text" id="login-email" placeholder="IDã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" class="w-full p-3 border rounded-xl">
                    <input type="password" id="login-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" class="w-full p-3 border rounded-xl">
                    <button class="w-full py-4 bg-8labo text-white font-bold rounded-xl shadow-lg">ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹</button>
                </form>
            </div>
        </section>

        <section id="page-dashboard" class="page space-y-8">
            <h3 class="text-xl font-black flex items-center gap-2"><i data-lucide="calendar"></i> äºˆç´„å¯èƒ½ãƒ—ãƒ­ã‚°ãƒ©ãƒ </h3>
            <div id="member-event-grid" class="grid md:grid-cols-2 gap-6"></div>
            <div class="calendar-container h-[450px] bg-white rounded-3xl overflow-hidden border">
                <iframe id="calendar-iframe" src="" width="100%" height="100%" frameborder="0"></iframe>
            </div>
        </section>

        <section id="page-mypage" class="page space-y-6">
            <button onclick="navigateTo('dashboard')" class="text-slate-400 font-bold flex items-center"><i data-lucide="chevron-left"></i> æˆ»ã‚‹</button>
            <div class="bg-white p-8 rounded-[3rem] shadow-sm border flex flex-col md:flex-row items-center gap-8">
                <div class="relative cursor-pointer" onclick="document.getElementById('photo-input').click()">
                    <div class="w-32 h-32 rounded-[2rem] overflow-hidden border-4 border-white shadow-lg">
                        <img id="my-profile-img" src="" class="w-full h-full object-cover">
                    </div>
                    <div class="absolute bottom-0 right-0 bg-8labo text-white p-2 rounded-full border-2 border-white"><i data-lucide="camera" class="w-4 h-4"></i></div>
                    <input type="file" id="photo-input" class="hidden" accept="image/*" onchange="handlePhotoChange(this)">
                </div>
                <div class="text-center md:text-left flex-grow">
                    <h3 id="my-name" class="text-3xl font-black">---</h3>
                    <p id="my-email" class="text-slate-400">---</p>
                </div>
                <div class="relative w-40 h-40 flex items-center justify-center">
                    <svg class="progress-ring" width="160" height="160"><circle cx="80" cy="80" r="70" stroke="#f1f5f9"/><circle id="prog-bar" cx="80" cy="80" r="70" stroke="#F39800" stroke-dasharray="0 440"/></svg>
                    <div class="absolute text-center">
                        <div id="my-rank" class="text-xl font-black text-8labo">RANK</div>
                        <div id="my-next" class="text-[10px] text-slate-400 font-bold">NEXT...</div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-6 rounded-3xl text-center border">
                    <div class="text-[10px] text-slate-400 font-black mb-1">å‚åŠ å›æ•°</div>
                    <div id="my-count" class="text-3xl font-black">0<span class="text-sm ml-1">å›</span></div>
                </div>
                <div class="bg-white p-6 rounded-3xl text-center border">
                    <div class="text-[10px] text-slate-400 font-black mb-1">ç´¯è¨ˆãƒã‚¤ãƒ³ãƒˆ</div>
                    <div id="my-points" class="text-3xl font-black">0<span class="text-sm ml-1">pt</span></div>
                </div>
            </div>
        </section>
    </main>

    <div id="modal-crop" class="modal-overlay">
        <div class="bg-white p-6 rounded-[2rem] max-w-sm w-full mx-4">
            <h3 class="font-black mb-4 text-center">å†™çœŸã‚’åˆ‡ã‚ŠæŠœã</h3>
            <div class="h-64 bg-black rounded-2xl overflow-hidden mb-6"><img id="crop-target" src=""></div>
            <button onclick="saveCrop()" class="w-full py-4 bg-8labo text-white font-bold rounded-xl">å®Œäº†</button>
        </div>
    </div>

    <script>
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwze0es2U8vBitvPy-ODBKIKFN9L1f2DfFMMHpsg2BhEYGRtFO6rLq8k-Zof3Rj64oYUQ/exec";
        let userData = null, eventsData = [], selectedEvent = null, cropper = null;

        // é€šä¿¡é–¢æ•°ï¼ˆCORSå¯¾å¿œï¼‰
        async function callApi(action, data = {}) {
            const res = await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ action, ...data }) });
            return res.json();
        }

        function navigateTo(p) {
            document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
            document.getElementById(`page-${p}`).classList.add('active');
            updateHeader();
            if(p === 'mypage') renderMyPage();
        }

        function handlePhotoChange(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('crop-target').src = e.target.result;
                document.getElementById('modal-crop').classList.add('active');
                if(cropper) cropper.destroy();
                cropper = new Cropper(document.getElementById('crop-target'), { aspectRatio: 1, viewMode: 1 });
            };
            reader.readAsDataURL(file);
        }

        async function saveCrop() {
            const b64 = cropper.getCroppedCanvas().toDataURL('image/jpeg');
            userData.profileImage = b64;
            await callApi('saveUserData', userData);
            document.getElementById('modal-crop').classList.remove('active');
            renderMyPage();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆæç”»ï¼ˆãƒœã‚¿ãƒ³å‹•ä½œã‚’ç‰©ç†çš„ã«å®ˆã‚‹ï¼‰
        function renderEvents() {
            const grids = [document.getElementById('guest-event-grid'), document.getElementById('member-event-grid')];
            grids.forEach(grid => {
                if(!grid) return;
                grid.innerHTML = eventsData.map(e => `
                    <div class="bg-white rounded-[2.5rem] p-6 border event-card">
                        <div class="flex justify-between mb-4"><span class="bg-orange-50 text-8labo px-3 py-1 rounded-lg font-bold">${e.date}</span></div>
                        <div class="flex justify-between items-start mb-4">
                            <h4 class="font-black text-xl">${e.title}</h4>
                            <button onclick="alert('${e.description}')" class="btn-safe-click w-8 h-8 bg-slate-50 rounded-full flex items-center justify-center text-slate-300"><i data-lucide="info" class="w-4 h-4"></i></button>
                        </div>
                        <div class="flex justify-between items-center mb-6">
                            <span class="text-8labo font-black text-xl">${e.time}</span>
                            <span class="font-black">Â¥${e.personalPrice.toLocaleString()}</span>
                        </div>
                        <button onclick="alert('äºˆç´„ç”»é¢ã¸')" class="btn-safe-click w-full py-4 bg-8labo text-white font-bold rounded-2xl shadow-lg">ç”³ã—è¾¼ã‚€</button>
                    </div>
                `).join('');
            });
            lucide.createIcons();
        }

        // åˆæœŸåŒ–
        window.onload = async () => {
            const res = await fetch(`${GAS_API_URL}?action=getEventsData`).then(r => r.json());
            eventsData = res.events;
            document.getElementById('calendar-iframe').src = res.calendarUrl;
            renderEvents();
            navigateTo('guest-top');
        };
    </script>
</body>
</html>
